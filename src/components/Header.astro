---
import type { Locale } from '~/types';
import { 
  getLocalizedText, 
  navItems, 
  getLocaleFromUrl
} from '~/utils/i18n';

interface Props {
  locale?: Locale;
}

const currentLocale = Astro.props.locale || getLocaleFromUrl(Astro.url);

// Language data with flags
const languages = [
  {
    code: 'ja',
    name: '日本語',
    flag: `<svg viewBox="0 0 900 600" class="w-5 h-3.5">
      <rect width="900" height="600" fill="#fff"/>
      <circle cx="450" cy="300" r="180" fill="#BC002D"/>
    </svg>`
  },
  {
    code: 'en',
    name: 'English',
    flag: `<svg viewBox="0 0 1200 600" class="w-5 h-3.5">
      <rect width="1200" height="600" fill="#012169"/>
      <path d="M0,0 L1200,600 M1200,0 L0,600" stroke="#fff" stroke-width="120"/>
      <path d="M600,0 V600 M0,300 H1200" stroke="#fff" stroke-width="200"/>
      <path d="M600,0 V600 M0,300 H1200" stroke="#C8102E" stroke-width="120"/>
      <path d="M0,0 L1200,600" stroke="#C8102E" stroke-width="80"/>
      <path d="M1200,0 L0,600" stroke="#C8102E" stroke-width="80"/>
    </svg>`
  },
  {
    code: 'zh',
    name: '中文',
    flag: `<svg viewBox="0 0 900 600" class="w-5 h-3.5">
      <rect width="900" height="600" fill="#DE2910"/>
      <polygon points="150,150 180,240 120,195 180,195 120,240" fill="#FFDE00"/>
      <polygon points="270,120 285,156 249,141 285,141 249,156" fill="#FFDE00"/>
      <polygon points="270,210 285,246 249,231 285,231 249,246" fill="#FFDE00"/>
      <polygon points="270,300 285,336 249,321 285,321 249,336" fill="#FFDE00"/>
      <polygon points="270,390 285,426 249,411 285,411 249,426" fill="#FFDE00"/>
    </svg>`
  },
  {
    code: 'ko',
    name: '한국어',
    flag: `<svg viewBox="0 0 900 600" class="w-5 h-3.5">
      <rect width="900" height="600" fill="#fff"/>
      <circle cx="450" cy="300" r="120" fill="none" stroke="#C60C30" stroke-width="80"/>
      <path d="M330,180 A120,120 0 0,1 570,180 A60,60 0 0,0 450,240 A60,60 0 0,1 330,180 Z" fill="#C60C30"/>
      <path d="M330,420 A120,120 0 0,0 570,420 A60,60 0 0,1 450,360 A60,60 0 0,0 330,420 Z" fill="#003478"/>
      <g stroke="#000" stroke-width="15" fill="none">
        <path d="M120,120 L240,240 M120,135 L240,255 M120,150 L240,270"/>
        <path d="M660,120 L780,240 M660,135 L780,255 M660,150 L780,270"/>
        <path d="M120,360 L240,480 M135,360 L255,480 M150,360 L270,480"/>
        <path d="M660,360 L780,480 M675,360 L795,480 M690,360 L810,480"/>
      </g>
    </svg>`
  }
];

const currentLanguage = languages.find(lang => lang.code === currentLocale);
const otherLanguages = languages.filter(lang => lang.code !== currentLocale);

// Build navigation URLs with base path
const baseUrl = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';
const homeUrl = currentLocale === 'ja' ? baseUrl : `${baseUrl}${currentLocale}/`;
const pricingUrl = currentLocale === 'ja' ? `${baseUrl}pricing/` : `${baseUrl}${currentLocale}/pricing/`;

// Logo text based on locale
const logoText = currentLocale === 'ja' ? 'SuperSheet' : 'SuperSheet';
---

<header 
  class="bg-white/95 backdrop-blur-sm border-b border-neutral-200 sticky top-0 z-50"
  role="banner"
>
  <div class="container-custom">
    <div class="flex items-center justify-between h-16 sm:h-20">
      <!-- Logo -->
      <div class="flex-shrink-0">
        <a 
          href={homeUrl}
          class="flex items-center space-x-2 text-2xl font-bold text-primary-600 hover:text-primary-700 transition-colors duration-200"
          aria-label={currentLocale === 'ja' ? 'SuperSheet ホームページ' : 'SuperSheet Home'}
        >
          <!-- Logo Icon/SVG -->
          <svg 
            class="w-8 h-8" 
            viewBox="0 0 32 32" 
            fill="none" 
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <rect width="32" height="32" rx="6" fill="currentColor"/>
            <rect x="6" y="6" width="20" height="20" rx="2" fill="white"/>
            <rect x="8" y="8" width="4" height="4" fill="currentColor"/>
            <rect x="14" y="8" width="4" height="4" fill="currentColor"/>
            <rect x="20" y="8" width="4" height="4" fill="currentColor"/>
            <rect x="8" y="14" width="4" height="4" fill="currentColor"/>
            <rect x="14" y="14" width="4" height="4" fill="currentColor"/>
            <rect x="20" y="14" width="4" height="4" fill="currentColor"/>
            <rect x="8" y="20" width="4" height="4" fill="currentColor"/>
            <rect x="14" y="20" width="4" height="4" fill="currentColor"/>
            <rect x="20" y="20" width="4" height="4" fill="currentColor"/>
          </svg>
          <span class="font-bold text-xl">
            {logoText}
          </span>
        </a>
      </div>

      <!-- Navigation & Language Switcher -->
      <nav class="hidden sm:flex items-center space-x-6" role="navigation">
        <!-- Navigation Links -->
        <div class="flex items-center space-x-6">
          <a 
            href={homeUrl}
            class="text-neutral-700 hover:text-primary-600 font-medium transition-colors duration-200 focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 rounded-sm px-2 py-1"
          >
            {getLocalizedText(navItems.home, currentLocale)}
          </a>
          
          <a 
            href={`${homeUrl}#features`}
            class="text-neutral-700 hover:text-primary-600 font-medium transition-colors duration-200 focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 rounded-sm px-2 py-1"
          >
            {getLocalizedText(navItems.features, currentLocale)}
          </a>

          <a 
            href={pricingUrl}
            class="text-neutral-700 hover:text-primary-600 font-medium transition-colors duration-200 focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 rounded-sm px-2 py-1"
          >
            {getLocalizedText(navItems.pricing, currentLocale)}
          </a>
        </div>

        <!-- Language Switcher -->
        <div class="flex items-center">
          <div class="relative">
            <button
              type="button"
              class="language-switcher-desktop inline-flex items-center px-3 py-2 text-sm font-medium text-neutral-700 bg-neutral-100 hover:bg-neutral-200 hover:text-primary-600 rounded-lg transition-colors duration-200 focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2"
              aria-label="Select language"
              aria-expanded="false"
              aria-haspopup="true"
            >
              <!-- Current Language Flag -->
              <Fragment set:html={currentLanguage?.flag} />
              
              <span class="ml-2">
                {currentLanguage?.name}
              </span>
              
              <!-- Dropdown Arrow -->
              <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>
            
            <!-- Dropdown Menu -->
            <div class="language-dropdown-desktop absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-neutral-200 py-1 z-50 hidden">
              {otherLanguages.map(language => {
                const langUrl = language.code === 'ja' ? '/' : `/${language.code}/`;
                return (
                  <a
                    href={langUrl}
                    class="flex items-center px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-100 transition-colors duration-200"
                    hreflang={language.code}
                  >
                    <Fragment set:html={language.flag} />
                    <span class="ml-3">{language.name}</span>
                  </a>
                );
              })}
            </div>
          </div>
        </div>
      </nav>

      <!-- Mobile Menu Button -->
      <div class="sm:hidden">
        <button
          type="button"
          class="mobile-menu-button inline-flex items-center justify-center p-2 rounded-md text-neutral-700 hover:text-primary-600 hover:bg-neutral-100 focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 transition-colors duration-200"
          aria-expanded="false"
          aria-controls="mobile-menu"
          aria-label={currentLocale === 'ja' ? 'メニューを開く' : 'Open menu'}
        >
          <!-- Menu Icon -->
          <svg 
            class="menu-icon block h-6 w-6" 
            fill="none" 
            viewBox="0 0 24 24" 
            stroke-width="1.5" 
            stroke="currentColor" 
            aria-hidden="true"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
          
          <!-- Close Icon -->
          <svg 
            class="close-icon hidden h-6 w-6" 
            fill="none" 
            viewBox="0 0 24 24" 
            stroke-width="1.5" 
            stroke="currentColor" 
            aria-hidden="true"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div 
      class="mobile-menu hidden sm:hidden border-t border-neutral-200 bg-white"
      id="mobile-menu"
      role="menu"
    >
      <div class="px-2 pt-2 pb-3 space-y-1">
        <a 
          href={homeUrl}
          class="block px-3 py-2 text-base font-medium text-neutral-700 hover:text-primary-600 hover:bg-neutral-100 rounded-md transition-colors duration-200"
          role="menuitem"
        >
          {getLocalizedText(navItems.home, currentLocale)}
        </a>
        
        <a 
          href={`${homeUrl}#features`}
          class="block px-3 py-2 text-base font-medium text-neutral-700 hover:text-primary-600 hover:bg-neutral-100 rounded-md transition-colors duration-200"
          role="menuitem"
        >
          {getLocalizedText(navItems.features, currentLocale)}
        </a>

        <a 
          href={pricingUrl}
          class="block px-3 py-2 text-base font-medium text-neutral-700 hover:text-primary-600 hover:bg-neutral-100 rounded-md transition-colors duration-200"
          role="menuitem"
        >
          {getLocalizedText(navItems.pricing, currentLocale)}
        </a>
        
        <!-- Mobile Language Switcher -->
        <div class="relative">
          <button
            type="button"
            class="language-switcher-mobile flex items-center justify-between w-full px-3 py-2 text-base font-medium text-neutral-700 hover:text-primary-600 hover:bg-neutral-100 rounded-md transition-colors duration-200"
            role="menuitem"
            aria-label="Select language"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <div class="flex items-center">
              <Fragment set:html={currentLanguage?.flag} />
              <span class="ml-3">{currentLanguage?.name}</span>
            </div>
            
            <!-- Dropdown Arrow -->
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          
          <!-- Mobile Dropdown Menu -->
          <div class="language-dropdown-mobile ml-6 mt-2 space-y-1 hidden">
            {otherLanguages.map(language => {
              const langUrl = language.code === 'ja' ? '/' : `/${language.code}/`;
              return (
                <a
                  href={langUrl}
                  class="flex items-center px-3 py-2 text-sm text-neutral-600 hover:text-primary-600 hover:bg-neutral-50 rounded-md transition-colors duration-200"
                  hreflang={language.code}
                  role="menuitem"
                >
                  <Fragment set:html={language.flag} />
                  <span class="ml-3">{language.name}</span>
                </a>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  // Mobile menu toggle functionality
  document.addEventListener('DOMContentLoaded', () => {
    const mobileMenuButton = document.querySelector('.mobile-menu-button') as HTMLButtonElement;
    const mobileMenu = document.querySelector('.mobile-menu') as HTMLElement;
    const menuIcon = document.querySelector('.menu-icon') as HTMLElement;
    const closeIcon = document.querySelector('.close-icon') as HTMLElement;

    if (mobileMenuButton && mobileMenu && menuIcon && closeIcon) {
      mobileMenuButton.addEventListener('click', () => {
        const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
        
        // Toggle menu visibility
        mobileMenu.classList.toggle('hidden');
        
        // Update aria-expanded
        mobileMenuButton.setAttribute('aria-expanded', (!isExpanded).toString());
        
        // Toggle icons
        menuIcon.classList.toggle('hidden');
        closeIcon.classList.toggle('hidden');
        
        // Focus management
        if (!isExpanded) {
          // Menu is opening, focus first menu item
          const firstMenuItem = mobileMenu.querySelector('a');
          firstMenuItem?.focus();
        }
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!mobileMenuButton.contains(e.target as Node) && !mobileMenu.contains(e.target as Node)) {
          mobileMenu.classList.add('hidden');
          mobileMenuButton.setAttribute('aria-expanded', 'false');
          menuIcon.classList.remove('hidden');
          closeIcon.classList.add('hidden');
        }
      });

      // Handle escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          mobileMenuButton.setAttribute('aria-expanded', 'false');
          menuIcon.classList.remove('hidden');
          closeIcon.classList.add('hidden');
          mobileMenuButton.focus();
        }
      });
    }

    // Language switcher dropdown functionality
    const desktopLanguageSwitcher = document.querySelector('.language-switcher-desktop') as HTMLButtonElement;
    const desktopLanguageDropdown = document.querySelector('.language-dropdown-desktop') as HTMLElement;
    const mobileLanguageSwitcher = document.querySelector('.language-switcher-mobile') as HTMLButtonElement;
    const mobileLanguageDropdown = document.querySelector('.language-dropdown-mobile') as HTMLElement;

    // Desktop language switcher
    if (desktopLanguageSwitcher && desktopLanguageDropdown) {
      desktopLanguageSwitcher.addEventListener('click', () => {
        const isExpanded = desktopLanguageSwitcher.getAttribute('aria-expanded') === 'true';
        desktopLanguageDropdown.classList.toggle('hidden');
        desktopLanguageSwitcher.setAttribute('aria-expanded', (!isExpanded).toString());
      });

      // Close desktop dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!desktopLanguageSwitcher.contains(e.target as Node) && !desktopLanguageDropdown.contains(e.target as Node)) {
          desktopLanguageDropdown.classList.add('hidden');
          desktopLanguageSwitcher.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Mobile language switcher
    if (mobileLanguageSwitcher && mobileLanguageDropdown) {
      mobileLanguageSwitcher.addEventListener('click', () => {
        const isExpanded = mobileLanguageSwitcher.getAttribute('aria-expanded') === 'true';
        mobileLanguageDropdown.classList.toggle('hidden');
        mobileLanguageSwitcher.setAttribute('aria-expanded', (!isExpanded).toString());
      });
    }

    // Close language dropdowns on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (desktopLanguageDropdown && !desktopLanguageDropdown.classList.contains('hidden')) {
          desktopLanguageDropdown.classList.add('hidden');
          desktopLanguageSwitcher?.setAttribute('aria-expanded', 'false');
          desktopLanguageSwitcher?.focus();
        }
        if (mobileLanguageDropdown && !mobileLanguageDropdown.classList.contains('hidden')) {
          mobileLanguageDropdown.classList.add('hidden');
          mobileLanguageSwitcher?.setAttribute('aria-expanded', 'false');
        }
      }
    });
  });
</script>

<style>
  /* Ensure mobile menu animation is smooth */
  .mobile-menu {
    transition: all 0.2s ease-in-out;
  }

  /* Enhanced focus styles for better accessibility */
  .mobile-menu a:focus {
    outline: 2px solid #6366f1;
    outline-offset: 2px;
  }

  /* Reduce motion for users who prefer it */
  @media (prefers-reduced-motion: reduce) {
    .mobile-menu,
    .mobile-menu-button,
    nav a {
      transition: none !important;
    }
  }
</style>